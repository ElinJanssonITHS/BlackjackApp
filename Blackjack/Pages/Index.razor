@page "/"

<PageTitle>Blackjack</PageTitle>

<h1>Blackjack</h1>
@* Cards *@

@foreach (var card in deck)
{
    <span class="display-3">@card.Symbol</span>
}

@* Dealer *@
<div class="text-danger display-3">Dealer</div>
@foreach (var card in dealerCards)
{
    <span class="text-danger display-3">@card.Symbol</span>
}
<span class="text-danger display-3">&nbsp;@dealerScore</span>

@* Player *@
<div class="text-success display-3">Player</div>
@foreach (var card in playerCards)
{
    <span class="text-success display-3">@card.Symbol</span>
}
<span class="text-success display-3">&nbsp;@playerScore</span>

<div mt-4>
    @if (!stay)
    {
        <button class="btn btn-success text-white text-center" @onclick="(() => DealCards(ref playerCards, PlayerTypes.Player))">Draw Card</button>
        <button class="btn btn-danger text-white text-center" @onclick="Stay">Stay</button>
        
    }
    else
    {
        <button class="btn btn-primary text-white text-center" @onclick="NewGame">New Game</button>
    }

</div>


@code {
    enum PlayerTypes
    {
        Dealer,
        Player
    }
    enum Results
    {
        Unknown,
        Blackjack,
        PlayerLost,
        DealerLost
    }
    string[] unicodeCards = { "🂡", "🂢", "🂣", "🂤", "🂥", "🂦", "🂧", "🂨", "🂩", "🂪", "🂫", "🂭", "🂮" };
    const int numberOfCards = 52;
    bool stay;

    Card[] deck = new Card[numberOfCards];
    Card[] playerCards = new Card[0];
    Card[] dealerCards = new Card[0];
    int playerScore = 0; int dealerScore = 0;

    string winner = string.Empty;

    Results result = Results.Unknown;

    protected override void OnInitialized() => NewGame();

    void NewGame()
    {
        playerCards = new Card[0];
        dealerCards = new Card[0];
        stay = false;
        playerScore = 0; dealerScore = 0;
        winner = string.Empty; result = Results.Unknown;

        Card[] cards = CreateDeck();
        deck = ShuffleDeck(cards);

        DealCards(ref dealerCards, PlayerTypes.Dealer, 2);
        DealCards(ref playerCards, PlayerTypes.Player, 2);
    }
    Card[] CreateDeck()
    {
        var cards = new Card[numberOfCards];
        int index = 0;
        for (int i = 0; i < 4; i++)
        {
            for (int j = 0; j < unicodeCards.Length; j++)
            {
                int value = j > 9 ? 10 : j + 1;
                cards[index] = new Card(unicodeCards[j], value);
                index++;
            }
        }
        return cards;
    }
    Card[] ShuffleDeck(Card[] cards)
    {
        Random random = new();
        for (int i = 0; i < cards.Length; i++)
        {
            int swap = random.Next(cards.Length);
            Card temp = cards[i];
            cards[i] = cards[swap];
            cards[swap] = temp;
        }
        return cards;
    }
    void DealCards(ref Card[] cards, PlayerTypes playerType, int takeCards = 1)
    {
        cards = cards.Concat(deck[0..takeCards]).ToArray();
        cards = deck[takeCards..];

        if (playerType.Equals(PlayerTypes.Player))
        {
            CalculateScore(cards, out playerScore);

            if (cards.Count().Equals(2) && playerScore.Equals(21))
            {
                result = Results.Blackjack;
                Stay();
            }
            if (playerScore > 21)
            {
                result = Results.PlayerLost;
                Stay();
            }
        }
        else
        {
            if (!stay)
            {
                cards[0].IsHidden = true;
            }

            CalculateScore(cards, out dealerScore);

            if (dealerScore > 21)
            {
                result = Results.DealerLost;
            }
        }

    }
    void Stay()
    {
        stay = true;
        dealerCards[0].IsHidden = false;

        if (!result.Equals(Results.Blackjack) && !result.Equals(Results.PlayerLost))
        {
            DrawDealerCards();
        }
    }
    void DrawDealerCards()
    {
        while (dealerScore < 17)
        {
            DealCards(ref dealerCards, PlayerTypes.Dealer);
        }
    }
    void CalculateScore(Card[] cards, out int score)
    {
        score = cards.Sum(c => c.Value);
        var aces = cards.Where(c => c.Value.Equals(1) && !c.IsHidden);

        foreach (var ace in aces)
        {
            if (score <= 11)
            {
                score += 10;
            }
        }
    }


}
